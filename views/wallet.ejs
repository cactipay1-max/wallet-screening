<%
  /* ── EJS helpers (UI only, no backend changes) ────────────────── */
  function etherscanUrl(chain, addr) {
    if (chain === 'ethereum' && addr) return 'https://etherscan.io/address/' + addr;
    return null;
  }
  function addrPill(chain, addr) {
    if (!addr) return '<span class="addr-pill">—</span>';
    var url = etherscanUrl(chain, addr);
    if (url) {
      return '<a class="addr-pill" href="' + url + '" target="_blank" rel="noopener noreferrer">' + addr + '</a>';
    }
    return '<span class="addr-pill">' + addr + '</span>';
  }
%>
<p style="margin-bottom:16px"><a href="/">&larr; Back to Dashboard</a></p>

<% if (error) { %>
  <div class="error"><%= error %></div>
<% } %>

<% if (wallet) { %>
<h1>Wallet Detail</h1>

<div class="card">
  <h2>
    <%- addrPill(wallet.chain, wallet.address) %>
    &nbsp;
    <span class="badge badge-<%= wallet.status %>"><%= wallet.status %></span>
  </h2>
  <br/>
  <dl class="dl">
    <dt>Chain</dt>
    <dd><%= wallet.chain %></dd>

    <dt>Status</dt>
    <dd><span class="badge badge-<%= wallet.status %>"><%= wallet.status %></span></dd>

    <dt>Last Checked</dt>
    <dd>
      <%= wallet.last_checked_at
          ? new Date(wallet.last_checked_at).toLocaleString()
          : '—' %>
    </dd>

    <dt>Added</dt>
    <dd class="meta"><%= new Date(wallet.created_at).toLocaleString() %></dd>

    <dt>ID</dt>
    <dd class="mono meta"><%= wallet.id %></dd>
  </dl>
</div>

<div class="card">
  <h2>Last Screening Log</h2>
  <% if (!log) { %>
    <p class="empty">No screening log found.</p>
  <% } else { %>
    <%
      const d = log.details || {};
      const flags = d.flags || [];
    %>
    <dl class="dl">
      <dt>Checked At</dt>
      <dd><%= new Date(log.checked_at).toLocaleString() %></dd>

      <dt>Result</dt>
      <dd>
        <% const s = log.status || (log.direct_match ? 'blacklisted' : 'clean'); %>
        <span class="badge badge-<%= s %>"><%= s %></span>
      </dd>

      <dt>Reason</dt>
      <dd><%= log.reason || '—' %></dd>

      <% if (flags.length > 0) { %>
      <dt>Flags</dt>
      <dd>
        <ul style="margin:0;padding-left:18px">
          <% flags.forEach(f => { %><li><%= f %></li><% }) %>
        </ul>
      </dd>
      <% } %>

      <dt>Direct Match</dt>
      <dd>
        <% if (log.direct_match) { %>
          <span class="badge badge-blacklisted">Yes</span>
          <% if (log.matched_blacklist_address) { %>
            &nbsp;<%- addrPill(wallet.chain, log.matched_blacklist_address) %>
          <% } %>
        <% } else { %>
          <span class="badge badge-clean">No</span>
        <% } %>
      </dd>

      <%
        const hopPaths = Array.isArray(d.paths) ? d.paths : [];
        const hopHit   = hopPaths.length > 0 ? hopPaths[0].hop : 0;
        const hop1Chk  = d.hop1_checked != null ? d.hop1_checked : '—';
        const hop2Chk  = d.hop2_checked != null ? d.hop2_checked : '—';
      %>
      <dt>Hop Detection</dt>
      <dd>
        <% if (d.rate_limited) { %>
          <span class="badge badge-inconclusive">inconclusive</span>
          <span class="meta">&nbsp;rate limited at&nbsp;<%= d.where || 'screening' %></span>
        <% } else if (hopHit === 0) { %>
          <span class="badge badge-clean">none</span>
        <% } else { %>
          <span class="badge badge-flagged"><%= hopHit %>-hop</span>
          <div class="hop-paths">
            <% hopPaths.slice(0, 3).forEach(function(p) { %>
              <div class="hop-path">
                <%- addrPill(wallet.chain, p.from||'') %>
                <% if (p.hop === 2) { %>
                  <span class="hop-arrow">→</span>
                  <%- addrPill(wallet.chain, p.via||'') %>
                <% } %>
                <span class="hop-arrow">→</span>
                <%- addrPill(wallet.chain, p.hit||'') %>
                <% if (p.category) { %>
                  <span class="badge badge-blacklisted"><%= p.category %></span>
                <% } %>
              </div>
            <% }); %>
          </div>
        <% } %>
        <div class="meta hop-counts">hop1 checked: <%= hop1Chk %>&nbsp;&nbsp;hop2 checked: <%= hop2Chk %></div>
      </dd>

      <% if (d.txs_count !== undefined) { %>
      <dt>Txs Fetched</dt>
      <dd><%= d.txs_count %> normal / <%= d.token_txs_count %> token</dd>

      <dt>Outgoing / Incoming</dt>
      <dd><%= d.outgoing_count %> / <%= d.incoming_count %></dd>
      <% } else if (log.raw_tx_count !== null && log.raw_tx_count !== undefined) { %>
      <dt>Raw Tx Count</dt>
      <dd><%= log.raw_tx_count %></dd>
      <% } %>

      <dt>Log ID</dt>
      <dd class="mono meta"><%= log.id %></dd>
    </dl>
  <% } %>
</div>
<% } %>
