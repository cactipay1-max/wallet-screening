<style>
.badge-inconclusive{background:#fef3c7;color:#92400e}
.hop-addr{color:inherit;text-decoration:underline;text-decoration-style:dotted;word-break:break-all}
.hop-addr:hover{text-decoration:underline}
</style>
<p style="margin-bottom:16px"><a href="/">&larr; Back to Dashboard</a></p>

<% if (error) { %>
  <div class="error"><%= error %></div>
<% } %>

<% if (wallet) { %>
<h1>Wallet Detail</h1>

<div class="card">
  <h2>
    <span class="mono" style="font-size:15px"><%= wallet.address %></span>
    &nbsp;
    <span class="badge badge-<%= wallet.status %>"><%= wallet.status %></span>
  </h2>
  <br/>
  <dl class="dl">
    <dt>Chain</dt>
    <dd><%= wallet.chain %></dd>

    <dt>Status</dt>
    <dd><span class="badge badge-<%= wallet.status %>"><%= wallet.status %></span></dd>

    <dt>Last Checked</dt>
    <dd>
      <%= wallet.last_checked_at
          ? new Date(wallet.last_checked_at).toLocaleString()
          : '—' %>
    </dd>

    <dt>Added</dt>
    <dd class="meta"><%= new Date(wallet.created_at).toLocaleString() %></dd>

    <dt>ID</dt>
    <dd class="mono meta"><%= wallet.id %></dd>
  </dl>
</div>

<div class="card">
  <h2>Last Screening Log</h2>
  <% if (!log) { %>
    <p class="empty">No screening log found.</p>
  <% } else { %>
    <%
      const d = log.details || {};
      const flags = d.flags || [];
    %>
    <dl class="dl">
      <dt>Checked At</dt>
      <dd><%= new Date(log.checked_at).toLocaleString() %></dd>

      <dt>Result</dt>
      <dd>
        <% const s = log.status || (log.direct_match ? 'blacklisted' : 'clean'); %>
        <span class="badge badge-<%= s %>"><%= s %></span>
      </dd>

      <dt>Reason</dt>
      <dd><%= log.reason || '—' %></dd>

      <% if (flags.length > 0) { %>
      <dt>Flags</dt>
      <dd>
        <ul style="margin:0;padding-left:18px">
          <% flags.forEach(f => { %><li><%= f %></li><% }) %>
        </ul>
      </dd>
      <% } %>

      <dt>Direct Blacklist Match</dt>
      <dd>
        <% if (log.direct_match) { %>
          <span class="badge badge-blacklisted">Yes</span>
          <% if (log.matched_blacklist_address) { %>
            &nbsp;<span class="mono meta"><%= log.matched_blacklist_address %></span>
          <% } %>
        <% } else { %>
          <span class="badge badge-clean">No</span>
        <% } %>
      </dd>

      <%
        const hopPaths = Array.isArray(d.paths) ? d.paths : [];
        const hopHit   = hopPaths.length > 0 ? hopPaths[0].hop : 0;
        const hop1Chk  = d.hop1_checked != null ? d.hop1_checked : '—';
        const hop2Chk  = d.hop2_checked != null ? d.hop2_checked : '—';
      %>
      <dt>Hop Detection</dt>
      <dd>
        <% if (d.rate_limited) { %>
          <span class="badge badge-inconclusive">inconclusive</span>
          <span class="meta">&nbsp;rate limited at&nbsp;<%= d.where || 'screening' %></span>
        <% } else if (hopHit === 0) { %>
          <span class="badge badge-clean">none</span>
        <% } else { %>
          <span class="badge badge-flagged"><%= hopHit %>-hop</span>
          <ul style="margin:6px 0 0;padding:0;list-style:none;font-size:12px">
            <% hopPaths.slice(0, 3).forEach(function(p) { %>
              <li style="margin-bottom:4px;word-break:break-all">
                <% if (wallet.chain === 'ethereum') { %>
                  <a class="mono hop-addr" href="https://etherscan.io/address/<%= p.from||'' %>" target="_blank" rel="noopener noreferrer"><%= p.from||'' %></a>
                <% } else { %>
                  <span class="mono"><%= p.from||'' %></span>
                <% } %>
                <% if (p.hop === 2) { %>
                  &nbsp;→&nbsp;
                  <% if (wallet.chain === 'ethereum') { %>
                    <a class="mono hop-addr" href="https://etherscan.io/address/<%= p.via||'' %>" target="_blank" rel="noopener noreferrer"><%= p.via||'' %></a>
                  <% } else { %>
                    <span class="mono"><%= p.via||'' %></span>
                  <% } %>
                <% } %>
                &nbsp;→&nbsp;
                <% if (wallet.chain === 'ethereum') { %>
                  <a href="https://etherscan.io/address/<%= p.hit||'' %>" target="_blank" rel="noopener noreferrer" class="hop-addr">
                    <span class="mono badge badge-blacklisted" style="font-size:10px;letter-spacing:0"><%= p.hit||'' %></span>
                  </a>
                <% } else { %>
                  <span class="mono badge badge-blacklisted" style="font-size:10px;letter-spacing:0"><%= p.hit||'' %></span>
                <% } %>
                <% if (p.category) { %>&nbsp;<span class="badge badge-blacklisted"><%= p.category %></span><% } %>
              </li>
            <% }); %>
          </ul>
        <% } %>
        <br/><span class="meta" style="font-size:11px">hop1 checked:&nbsp;<%= hop1Chk %>&nbsp;&nbsp;hop2 checked:&nbsp;<%= hop2Chk %></span>
      </dd>

      <% if (d.txs_count !== undefined) { %>
      <dt>Txs Fetched</dt>
      <dd><%= d.txs_count %> normal / <%= d.token_txs_count %> token</dd>

      <dt>Outgoing / Incoming</dt>
      <dd><%= d.outgoing_count %> / <%= d.incoming_count %></dd>
      <% } else if (log.raw_tx_count !== null && log.raw_tx_count !== undefined) { %>
      <dt>Raw Tx Count</dt>
      <dd><%= log.raw_tx_count %></dd>
      <% } %>

      <dt>Log ID</dt>
      <dd class="mono meta"><%= log.id %></dd>
    </dl>
  <% } %>
</div>
<% } %>
